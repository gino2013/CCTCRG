#!/bin/bash

# Claude Code Quick Initialization Tool
# Allows users to quickly enable Claude Code optimization in any project

set -e

# Color definitions
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_success() { printf "${GREEN}âœ… $1${NC}\n"; }
print_info() { printf "${BLUE}â„¹ï¸  $1${NC}\n"; }
print_warning() { printf "${YELLOW}âš ï¸  $1${NC}\n"; }

# Check if global configuration exists
check_global_config() {
    if [[ -d "$HOME/.claude-code-guide" ]]; then
        return 0
    else
        return 1
    fi
}

# Quick initialization of current project
quick_init() {
    local project_dir=$(pwd)
    local project_name=$(basename "$project_dir")
    
    print_info "Quick initialization Claude Code guide to: $project_name"
    
    # Check if global configuration exists
    if check_global_config; then
        print_info "Using global configuration..."
        local config_dir="$HOME/.claude-code-guide"
        
        # Copy core files
        cp "$config_dir/ClaudeCodeOptimizationGuide.md" "$project_dir/" 2>/dev/null || print_warning "Cannot find optimization guide"
        cp "$config_dir/PromptTemplates.md" "$project_dir/" 2>/dev/null || print_warning "Cannot find template library"
        cp "$config_dir/QuickStartGuide.md" "$project_dir/" 2>/dev/null || print_warning "Cannot find quick guide"
        
        # Generate project-specific CLAUDE.md
        cat > "$project_dir/CLAUDE.md" << EOF
# Claude Code å°ˆæ¡ˆè¨˜æ†¶æ–‡ä»¶

## ðŸ“‹ å°ˆæ¡ˆåŸºæœ¬ä¿¡æ¯
- **å°ˆæ¡ˆåç¨±**: $project_name
- **æŠ€è¡“æ£§**: [è«‹å¡«å…¥ä½ çš„æŠ€è¡“æ£§]
- **é–‹ç™¼æŒ‡ä»¤**: [è«‹å¡«å…¥é–‹ç™¼æŒ‡ä»¤]

## ðŸŽ¯ Claude Code äº’å‹•åŽŸå‰‡
åƒè€ƒå°ˆæ¡ˆä¸­çš„ ClaudeCodeOptimizationGuide.md å’Œ CLAUDE.mdï¼Œè«‹éµå¾ª token ç¯€çœåŽŸå‰‡ã€‚

## ðŸ“ å°ˆæ¡ˆç‰¹å®šèªªæ˜Ž
[åœ¨é€™è£¡æ·»åŠ å°ˆæ¡ˆç‰¹å®šçš„é‡è¦ä¿¡æ¯]

---
> è¨˜å¾—ç·¨è¼¯é€™å€‹æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„å°ˆæ¡ˆç‰¹å®šä¿¡æ¯ï¼
EOF
        
        print_success "Initialization complete!"
        print_info "Please edit CLAUDE.md to fill in project-specific information"
        
    else
        print_warning "Cannot find global configuration, downloading..."
        # If no global configuration, provide simplified version
        create_minimal_setup "$project_dir" "$project_name"
    fi
}

# Create minimal setup
create_minimal_setup() {
    local project_dir=$1
    local project_name=$2
    
    # Create basic CLAUDE.md
    cat > "$project_dir/CLAUDE.md" << 'EOF'
# Claude Code å°ˆæ¡ˆè¨˜æ†¶æ–‡ä»¶

## ðŸ“‹ å°ˆæ¡ˆåŸºæœ¬ä¿¡æ¯
- **å°ˆæ¡ˆåç¨±**: [è«‹å¡«å…¥å°ˆæ¡ˆåç¨±]
- **æŠ€è¡“æ£§**: [è«‹å¡«å…¥æŠ€è¡“æ£§]
- **é–‹ç™¼æŒ‡ä»¤**: [è«‹å¡«å…¥é–‹ç™¼æŒ‡ä»¤]

## ðŸŽ¯ Claude Code äº’å‹•åŽŸå‰‡
æ¯æ¬¡èˆ‡ Claude Code äº’å‹•æ™‚è«‹åŒ…å«ï¼š
```
åƒè€ƒå°ˆæ¡ˆä¸­çš„ CLAUDE.mdï¼Œè«‹éµå¾ªä»¥ä¸‹åŽŸå‰‡ï¼š
- åªè¼¸å‡ºä»£ç¢¼ï¼Œä¸éœ€è¦è§£é‡‹
- éµå¾ªå°ˆæ¡ˆä»£ç¢¼é¢¨æ ¼
- åŒ…å«é©ç•¶çš„éŒ¯èª¤è™•ç†
```

## ðŸ’¡ å¸¸ç”¨æ¨¡æ¿

### å¿«é€Ÿé–‹ç™¼æ¨¡æ¿
```
åŸºæ–¼ CLAUDE.md è¨­å®šï¼Œå‰µå»º [åŠŸèƒ½åç¨±]ï¼š
- åŠŸèƒ½: [æ ¸å¿ƒåŠŸèƒ½]
- æŠ€è¡“: [ä½¿ç”¨æŠ€è¡“]
- è¼¸å‡º: å®Œæ•´ä»£ç¢¼æ–‡ä»¶
```

### Bug ä¿®å¾©æ¨¡æ¿
```
æ ¹æ“š CLAUDE.md è¦ç¯„ï¼Œä¿®å¾© [å•é¡Œæè¿°]ï¼š
- ç¾è±¡: [éŒ¯èª¤è¡¨ç¾]
- æœŸæœ›: [æ­£ç¢ºè¡Œç‚º] 
- è¼¸å‡º: ä¿®å¾©å¾Œçš„ä»£ç¢¼
```

---
> é€™æ˜¯ç°¡åŒ–ç‰ˆé…ç½®ï¼Œå»ºè­°åŸ·è¡Œå®Œæ•´å®‰è£ç²å¾—æ›´å¤šåŠŸèƒ½
EOF

    # Create simple usage guide
    cat > "$project_dir/CLAUDE_USAGE.md" << 'EOF'
# Claude Code å¿«é€Ÿä½¿ç”¨æŒ‡å—

## ðŸš€ ç«‹å³ä½¿ç”¨

æ¯æ¬¡èˆ‡ Claude Code äº’å‹•æ™‚ï¼Œè«‹åŠ å…¥é€™æ®µè©±ï¼š
```
åƒè€ƒå°ˆæ¡ˆä¸­çš„ CLAUDE.mdï¼Œè«‹éµå¾ª token ç¯€çœåŽŸå‰‡ã€‚
```

## ðŸ“ å¸¸ç”¨å ´æ™¯

### é–‹ç™¼æ–°åŠŸèƒ½
```
æ ¹æ“š CLAUDE.md è¨­å®šï¼Œå‰µå»º [åŠŸèƒ½åç¨±]ï¼š
- åŠŸèƒ½: [å…·é«”åŠŸèƒ½æè¿°]
- æŠ€è¡“: [ä½¿ç”¨çš„æŠ€è¡“]
- è¼¸å‡º: å®Œæ•´å¯åŸ·è¡Œä»£ç¢¼
```

### ä¿®å¾©å•é¡Œ
```
åŸºæ–¼ CLAUDE.md è¦ç¯„ï¼Œä¿®å¾© [å•é¡Œæè¿°]ï¼š
- ç¾è±¡: [å…·é«”éŒ¯èª¤]
- æœŸæœ›: [æ­£ç¢ºè¡Œç‚º]
- è¼¸å‡º: ä¿®å¾©å¾Œä»£ç¢¼
```

## ðŸ’¡ é€²éšŽä½¿ç”¨

å»ºè­°åŸ·è¡Œå®Œæ•´å®‰è£ä»¥ç²å¾—ï¼š
- å®Œæ•´çš„å„ªåŒ–æŒ‡å—
- è±å¯Œçš„æ¨¡æ¿åº«
- è‡ªå‹•åŒ–å·¥å…·

å®‰è£æŒ‡ä»¤ï¼š
```bash
curl -sSL [your-install-url] | bash
```
EOF

    print_success "Basic configuration created"
    print_info "See CLAUDE_USAGE.md for usage instructions"
}

# Show status
show_status() {
    echo
    print_info "Claude Code guide status check"
    echo
    
    # Check global configuration
    if check_global_config; then
        print_success "Global configuration: Installed (~/.claude-code-guide/)"
    else
        print_warning "Global configuration: Not installed"
    fi
    
    # Check current project
    if [[ -f "./CLAUDE.md" ]]; then
        print_success "Current project: Configured"
    else
        print_warning "Current project: Not configured"
    fi
    
    # Check related files
    local files=("ClaudeCodeOptimizationGuide.md" "PromptTemplates.md" "QuickStartGuide.md")
    for file in "${files[@]}"; do
        if [[ -f "./$file" ]]; then
            print_success "File: $file"
        else
            print_warning "File: $file (missing)"
        fi
    done
    
    echo
}

# Main logic
case "${1:-}" in
    "status"|"-s"|"--status")
        show_status
        ;;
    "help"|"-h"|"--help")
        echo "Claude Code å¿«é€Ÿåˆå§‹åŒ–å·¥å…·"
        echo
        echo "ç”¨æ³•:"
        echo "  claude-init          # Quick initialization of current project"
        echo "  claude-init status   # æª¢æŸ¥å®‰è£ç‹€æ…‹"
        echo "  claude-init help     # é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯"
        echo
        ;;
    *)
        quick_init
        ;;
esac